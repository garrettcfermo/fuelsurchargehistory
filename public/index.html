<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Fuel Surcharge History</title>

  <!-------------------- Style Sheets ----------------------->
  <link rel="stylesheet" href="./assets/css/reset.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/css?family=Crete+Round" rel="stylesheet">
  <link rel="stylesheet" href="./assets/css/styles.css">

</head>

<body>

  <!-- Jumbotron-->
  <div class="container jumbotron">
    <h4 style="font-family: 'Crete Round', serif; text-decoration: underline; font-size:40px;">FedEx Fuel Surcharge</h4>
    <a class="waves-effect waves-light btn btn-small blue-grey darken-2 modal-trigger" href="#modal"><i class="material-icons">date_range</i></a>
    <a onclick="updateFSC()" class="waves-effect waves-light btn btn-small green darken-2 modal-trigger" href="#modal1"><i
        class="material-icons">sync</i></a>
    <a onclick="" class="waves-effect waves-light btn btn-small red lighten-2 modal-trigger" href="#modal3"><i class="material-icons">add</i></a>
    <hr>
  </div>

  <!-- Add Fsc Percentage -->
  <div id="modal3" class="modal">
    <div class="modal-content">
      <h4>Add FSC Percentage</h4>
      <hr>
      <br>
      <div>
        <div class="row">
          <div class="s8 input-field">
            <p>Effective Date</p>
            <input id="newEffectiveDate" type="date" placeholder="">
          </div>
        </div>
        <div class="row">
          <div class="input-field">
            <select id="newIndicator">
              <option value="" disabled selected>Choose your option</option>
              <option value="EXPRESS">Express</option>
              <option value="GROUND">Ground</option>
              <option value="INTL EXPORT">Intl Export</option>
              <option value="INTL IMPORT">Intl Import</option>
            </select>
            <label>Indicator</label>
          </div>
        </div>
        <div class="row">
          <div class="s8 input-field">
            <p>Percentage (Needs to be in decimal form)</p>
            <input id="newPercentage" type="text" placeholder="0.055">
          </div>
        </div>
        <div class="invalidInput" style="color:red"></div>
      </div>
    </div>
    <div class="center" style="margin-bottom:10px">
      <a href="#!" onclick="addPercentage()" class="modal-close waves-effect waves-green btn green darken-2">Submit</a>
      <a href="#!" class="modal-close waves-effect waves-gray btn blue-grey">Close</a>
    </div>
  </div>


  <!-- Scrap Data Modal Structure -->
  <div id="modal1" class="modal">
    <div class="modal-content">
      <h4>Update Results</h4>
      <hr>
      <div class="resultInfo"></div>
    </div>
    <div class="modal-footer">
      <a href="#!" onclick="closeSync()" class="modal-close waves-effect waves-grey btn btn-small right blue-grey">Close</a>
    </div>
  </div>

  <!-- Date Filter Modal Structure -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h4>Date Filter</h4>
      <p style="margin-bottom: 20px;">Please select a Date Range or custom dates</p>
      <div class="date-filter">
        <div class="row">
          <div class="s12 input-field">
            <p>Start Date</p>
            <input id="customStartDate" type="date" class="datepicker" placeholder="">
          </div>
        </div>
        <div class="row">
          <div class="s12 input-field">
            <p>End Date</p>
            <input id="customEndDate" type="date" class="datepicker" placeholder="">
          </div>
        </div>
        <div class="row" id="invalidDate" style="color:red"></div>
      </div>
      <div class="center">
        <a href="#!" onclick="customDate()" class="modal-close waves-effect waves-green btn green darken-2">Apply</a>
        <a href="#!" class="modal-close waves-effect waves-gray btn blue-grey">Close</a>
      </div>
    </div>
  </div>

  <!-- Chart Section -->
  <div class="container">
    <canvas style="margin-top:30px" id="myChart" width="400" height="200"></canvas>
  </div>

  <!-- Table Section -->
  <div class="container">
    <table class="centered">
      <thead>
        <tr>
          <th class="effectiveDate">Effective Date</th>
          <th>Express</th>
          <th>Ground</th>
          <th>Intl Export</th>
          <th>Intl Import</th>
          <th class="edit">Update</th>
        </tr>
      </thead>
      <tbody class="tableInfo">
      </tbody>
    </table>
  </div>

  <!-- Update Modal Structure -->
  <div id="modal2" class="modal">
    <div class="modal-content">
      <h4>Edit</h4>
      <p style="margin-bottom: 20px;">Please edit the informaton below:</p>
      <p style="margin-bottom: 20px;">Effective Date : 2018-12-03</p>

      <div class="row">
        <form class="col s12">
          <div class="row">
            <div class="input-field col s6">
              <input value="5%" id="" type="text" class="validate">
              <label for="">Express</label>
            </div>
            <div class="input-field col s6">
              <input value="6%" id="" type="tel" class="validate">
              <label for="">Ground</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s6">
              <input value="5%" id="" type="text" class="validate">
              <label for="i">International Export</label>
            </div>
            <div class="input-field col s6">
              <input value="6%" id="" type="tel" class="validate">
              <label for="">International Import</label>
            </div>
          </div>
        </form>
      </div>

      <div class="center">
        <a href="#!" class="modal-close waves-effect waves-green btn green darken-2">Save</a>
        <a href="#!" class="modal-close waves-effect waves-gray btn blue-grey">Close</a>
      </div>
    </div>
  </div>


  <!-------------------- Java Scripts ----------------------->
  <!-- Materialize -->
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>

  <!-- Moment JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.js"></script>

  <!-- Chart JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.js"></script>

  <!-- Ajax JS -->
  <script src="./assets/js/index.js"></script>

  <script>
    // Current Week
    let startDate = moment().startOf('month').format("YYYYMMDD")
    let endDate = moment().day(7).format("YYYYMMDD")

    //Fetch the Fuel History Data from Database
    function fuelhistoryData(startDate, endDate) {
      fetch(`/percentages/${startDate}-${endDate}`)
        .then(r => r.json())
        .then(r => {
          r.sort((a, b) => a.effective_date > b.effective_date ? 1 : -1)

          // Looping thru to put together Graph Data
          let dateArr = []
          let expressArr = []
          let expressKeyArr = []
          let groundArr = []
          let groundKeyArr = []
          let exportArr = []
          let exportKeyArr = []
          let importArr = []
          let importKeyArr = []

          r.forEach(elem => {
            if (dateArr.includes(elem.effective_date) === false) {
              dateArr.push(elem.effective_date)
            }

            switch (elem.indicator) {
              case 'EXPRESS':
                expressArr.push(Math.round((elem.percentage * 100) * 100) / 100)
                expressKeyArr.push(elem._id)
                break;
              case 'GROUND':
                groundArr.push(Math.round((elem.percentage * 100) * 100) / 100)
                groundKeyArr.push(elem._id)
                break;
              case 'INTL EXPORT':
                exportArr.push(Math.round((elem.percentage * 100) * 100) / 100)
                exportKeyArr.push(elem._id)
                break;
              case 'INTL IMPORT':
                importArr.push(Math.round((elem.percentage * 100) * 100) / 100)
                importKeyArr.push(elem._id)
                break
            }
          })

          Graph(dateArr, expressArr, groundArr, exportArr, importArr)

          tableCreation(dateArr, expressArr, expressKeyArr, groundArr, groundKeyArr, exportArr, exportKeyArr,
            importArr, importKeyArr)


        })
        .catch(e => console.log(e))
    }

    fuelhistoryData(startDate, endDate)

    //Web Scrap FedEx Fuel Percentage
    function updateFSC() {
      fetch(`/updatefsc`)
        .then(r => r.json())
        .then(r => {

          // Sort Data Newest to Oldest
          r.sort((a, b) => a.effective_date < b.effective_date ? 1 : -1)

          // Result Logic/Output
          if (r.length === 0) {

            let updateDate
            if (moment().format("dddd") === "Friday" && moment().format("HH:mm") >= "12:00") {
              updateDate = moment().day(12).format("dddd MM/DD/YYYY")
            } else {
              updateDate = moment().day(5).format("dddd MM/DD/YYYY")
            }

            document.querySelector('.resultInfo').innerHTML =
              `
            Everything is up-to-date! The next avialable update will be on <br><br>
            ${updateDate}, 12:00PM PST <br><br>
            For the Date Range: <br><br>
            ${moment().day(8).format("MM/DD/YYYY")} - ${moment().day(14).format("MM/DD/YYYY")}
             `
          } else {

            let expressCount = 0
            let groundCount = 0
            let exportCount = 0
            let importCount = 0
            r.forEach(elem => {
              switch (elem.indicator) {
                case 'EXPRESS':
                  expressCount++
                  break;
                case 'GROUND':
                  groundCount++
                  break;
                case 'INTL EXPORT':
                  exportCount++
                  break;
                case 'INTL IMPORT':
                  importCount++
                  break;
              }
            })

            document.querySelector('.resultInfo').innerHTML =
              `
            There were a total of ${r.length} records updated! Please is the update information below: <br><br>
            Date Range: ${moment(r[r.length-1].effective_date).format("MM/DD/YYYY")} - ${moment(r[0].effective_date).format("MM/DD/YYYY")}<br><br>
            Express: ${expressCount} <br><br>
            Ground: ${groundCount} <br><br>
            Intl Export: ${exportCount} <br><br>
            Intl Import: ${importCount} <br><br>
            `
          }
        })
        .catch(e => console.log(e))
    }

    // Cleans the Result Information 
    function closeSync() {
      document.querySelector('.resultInfo').innerHTML = ''
    }

    // Custom Date Filter
    function customDate() {
      let customStartDate = moment(document.querySelector('#customStartDate').value).format("YYYYMMDD")
      let customEndDate = moment(document.querySelector('#customEndDate').value).format("YYYYMMDD")
      if (customStartDate > customEndDate || customEndDate === "Invalid date" || customStartDate === "Invalid date") {
        document.querySelector('#invalidDate').innerHTML = `Invalid Date. Please select a correct date range.`
      } else {
        fuelhistoryData(customStartDate, customEndDate)
        document.querySelector('#invalidDate').innerHTML = ''
      }
    }

    // Graph Funcation
    function Graph(dateArr, expressArr, groundArr, exportArr, importArr) {
      Chart.defaults.global.defaultFontColor = 'black'
      new Chart(document.getElementById("myChart"), {
        type: 'line',
        legendText: "cross",
        data: {
          labels: dateArr,
          datasets: [{
            data: expressArr,
            label: "Express",
            borderColor: "#86B281",
            backgroundColor: "#86b281",
            fill: false
          }, {
            data: groundArr,
            label: "Ground",
            borderColor: "#bc8d88",
            backgroundColor: "#bc8d88",
            fill: false
          }, {
            data: exportArr,
            label: "Intl Export",
            borderColor: "#9DB3D5",
            backgroundColor: "#9DB3D5",
            fill: false
          }, {
            data: importArr,
            label: "Intl Import",
            borderColor: "#637885",
            backgroundColor: "#637885",
            fill: false
          }]
        },
        options: {
          legend: {
            position: 'bottom',
            markerColor: "circle"
          },
          scales: {
            yAxes: [{
              ticks: {
                callback: function (tick) {
                  return tick.toString() + '%';
                }
              }
            }]
          }
        }
      })
    }
    Graph()

    // Table Creation Function
    function tableCreation(dateArr, expressArr, expressKeyArr, groundArr, groundKeyArr, exportArr, exportKeyArr,
      importArr, importKeyArr) {

      document.querySelector('.tableInfo').innerHTML = ''

      for (let i = 0; i <= dateArr.length - 1; i++) {
        let listItem = document.createElement('tr')
        listItem.innerHTML =
          `
          <td class="effectiveDate">${dateArr[i]}</td>
          <td value=${expressKeyArr[i]}>${expressArr[i]}%</td>
          <td value=${groundKeyArr[i]}>${groundArr[i]}%</td>
          <td value=${exportKeyArr[i]}>${exportArr[i]}%</td>
          <td value=${importKeyArr[i]}>${importArr[i]}%</td>
          <td class="edit"> <a class=" waves-effect waves-light btn red lighten-2 modal-trigger" href="#modal2"><i class="material-icons">edit</i></a>
          </td>
        `
        document.querySelector('.tableInfo').appendChild(listItem)
      }
    }

    // Add a Percentage
    function addPercentage() {
      event.preventDefault()

      if (document.querySelector('#newPercentage').value > 1 ||
        document.querySelector('#newPercentage').value === "" ||
        document.querySelector('#newEffectiveDate').value === "" ||
        document.querySelector('#newIndicator').value === ""
      ) {
        document.querySelector('.invalidInput').innerHTML = `Incorrect input.Please update and try to submit again!`
      } else {

        fetch('/percentages', {
          method: 'POST',
          headers: {
            "Content-Type": "application/json; charset=utf-8",
          },
          body: JSON.stringify({
            createdAt: moment().format("YYYY-MM-DD"),
            updatedAt: moment().format("YYYY-MM-DD"),
            vendor_name: "FEDEX",
            effective_date: document.querySelector('#newEffectiveDate').value,
            indicator: document.querySelector('#newIndicator').value,
            percentage: document.querySelector('#newPercentage').value
          })
        }).then(r => {
          document.querySelector('#newEffectiveDate').value = ""
          document.querySelector('#newPercentage').value = ""
          document.querySelector('#newIndicator').value = "Choose your option"
          document.querySelector('.invalidInput').innerHTML = ''
          fuelhistoryData(startDate,endDate)
        }).catch(e => console.log(e))
      }
    }

    // Materialize Code to make Modals Work
    $(document).ready(function () {
      $('select').material_select();
    });
    $(document).ready(function () {
      $('.modal').modal()
    })
  </script>

</body>

</html>