<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Fuel Surcharge History</title>

  <!-------------------- Style Sheets ----------------------->
  <link rel="stylesheet" href="./assets/css/reset.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/css?family=Crete+Round" rel="stylesheet">
  <link rel="stylesheet" href="./assets/css/styles.css">

</head>

<body>

  <!-- Jumbotron-->
  <div class="container jumbotron">
    <h4 style="font-family: 'Crete Round', serif; text-decoration: underline; font-size:40px;">FedEx Fuel Surcharge</h4>
    <a class="waves-effect waves-light btn btn-small blue-grey darken-2 modal-trigger" href="#modal"><i class="material-icons">date_range</i></a>
    <a onclick="updateFSC()" class="waves-effect waves-light btn btn-small green darken-2 modal-trigger" href="#modal1"><i
        class="material-icons">sync</i></a>
    <hr>
  </div>

  <!-- Scrap Data Modal Structure -->
  <div id="modal1" class="modal">
    <div class="modal-content">
      <h4>Update Results</h4>
      <hr>
      <div class="resultInfo"></div>
    </div>
    <div class="modal-footer">
      <a href="#!" onclick="closeSync()" class="modal-close waves-effect waves-grey btn btn-small right blue-grey">Close</a>
    </div>
  </div>

  <!-- Date Filter Modal Structure -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h4>Date Filter</h4>
      <p style="margin-bottom: 20px;">Please select a Date Range or custom dates</p>
      <div class="date-filter">
        <div class="row">
          <div class="s12 input-field">
            <p>Start Date</p>
            <input id="customStartDate" type="date" class="datepicker" placeholder="">
          </div>
        </div>
        <div class="row">
          <div class="s12 input-field">
            <p>End Date</p>
            <input id="customEndDate" type="date" class="datepicker" placeholder="">
          </div>
        </div>
        <div class="row" id="invalidDate" style="color:red"></div>
      </div>
      <div class="center">
        <a href="#!" onclick="customDate()" class="modal-close waves-effect waves-green btn green darken-2">Apply</a>
        <a href="#!" class="modal-close waves-effect waves-gray btn blue-grey">Close</a>
      </div>
    </div>
  </div>

  <!-- Chart Section -->
  <div class="container">
    <canvas style="margin-top:30px" id="myChart" width="400" height="200"></canvas>
  </div>

  <!-- Table Section -->
  <div class="container">
    <table class="centered">
      <thead>
        <tr>
          <th class="effectiveDate">Effective Date</th>
          <th>Express</th>
          <th>Ground</th>
          <th>Intl Export</th>
          <th>Intl Import</th>
          <th class="edit">Update</th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td class="effectiveDate">2018-12-03</td>
          <td>5%</td>
          <td>6%</td>
          <td>7%</td>
          <td>8%</td>
          <td class="edit"> <a class=" waves-effect waves-light btn red lighten-2 modal-trigger" href="#modal2"><i
                class="material-icons">edit</i></a>
          </td>
        </tr>
        <tr>
          <td class="effectiveDate">2018-12-03</td>
          <td>5%</td>
          <td>6%</td>
          <td>7%</td>
          <td>8%</td>
          <td class="edit"> <a class=" waves-effect waves-light btn red lighten-2 modal-trigger" href="#modal2"><i
                class="material-icons">edit</i></a>
          </td>
        </tr>
        <tr>
          <td class="effectiveDate">2018-12-03</td>
          <td>5%</td>
          <td>6%</td>
          <td>7%</td>
          <td>8%</td>
          <td class="edit"> <a class=" waves-effect waves-light btn red lighten-2 modal-trigger" href="#modal2"><i
                class="material-icons">edit</i></a>
          </td>
        </tr>
        <tr>
          <td class="effectiveDate">2018-12-03</td>
          <td>5%</td>
          <td>6%</td>
          <td>7%</td>
          <td>8%</td>
          <td class="edit"> <a class=" waves-effect waves-light btn red lighten-2 modal-trigger" href="#modal2"><i
                class="material-icons">edit</i></a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Update Modal Structure -->
  <div id="modal2" class="modal">
    <div class="modal-content">
      <h4>Edit</h4>
      <p style="margin-bottom: 20px;">Please edit the informaton below:</p>
      <p style="margin-bottom: 20px;">Effective Date : 2018-12-03</p>

      <div class="row">
        <form class="col s12">
          <div class="row">
            <div class="input-field col s6">
              <input value="5%" id="icon_prefix" type="text" class="validate">
              <label for="icon_prefix">Express</label>
            </div>
            <div class="input-field col s6">
              <input value="6%" id="icon_telephone" type="tel" class="validate">
              <label for="icon_telephone">Ground</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s6">
              <input value="5%" id="icon_prefix" type="text" class="validate">
              <label for="icon_prefix">International Export</label>
            </div>
            <div class="input-field col s6">
              <input value="6%" id="icon_telephone" type="tel" class="validate">
              <label for="icon_telephone">International Import</label>
            </div>
          </div>
        </form>
      </div>

      <div class="center">
        <a href="#!" class="modal-close waves-effect waves-green btn green darken-2">Save</a>
        <a href="#!" class="modal-close waves-effect waves-gray btn blue-grey">Close</a>
      </div>
    </div>
  </div>


  <!-------------------- Java Scripts ----------------------->
  <!-- Materialize -->
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>

  <!-- Moment JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.js"></script>

  <!-- Chart JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.js"></script>

  <!-- Ajax JS -->
  <script src="./assets/js/index.js"></script>

  <script>
    // Current Week
    let startDate = moment().startOf('month').format("YYYYMMDD")
    let endDate = moment().day(7).format("YYYYMMDD")

    //Fetch the Fuel History Data from Database
    function fuelhistoryData(startDate, endDate) {
      fetch(`/percentages/${startDate}-${endDate}`)
        .then(r => r.json())
        .then(r => {
          r.sort((a, b) => a.effective_date > b.effective_date ? 1 : -1)

          let dateArr=[]
          let expressArr=[]
          let groundArr=[]
          let exportArr =[]
          let importArr= []

        //
        r.forEach(elem => {
           if (dateArr.includes(elem.effective_date) === false) {
            dateArr.push(elem.effective_date)
          }
          
          switch(elem.indicator){
            case 'EXPRESS':
              expressArr.push(elem.percentage*100)
            break;
            case 'GROUND':
              groundArr.push(elem.percentage * 100)
            break;
            case 'INTL EXPORT':
              exportArr.push(elem.percentage * 100)
            break;
            case 'INTL IMPORT':
              importArr.push(elem.percentage * 100)
            break
          }
        })

        Graph(dateArr,expressArr,groundArr,exportArr,importArr)

        })
        .catch(e => console.log(e))
    }

    fuelhistoryData(startDate, endDate)

    //Web Scrap FedEx Fuel Percentage
    function updateFSC() {
      fetch(`/updatefsc`)
        .then(r => r.json())
        .then(r => {

          // Sort Data Newest to Oldest
          r.sort((a, b) => a.effective_date < b.effective_date ? 1 : -1)

          // Result Logic/Output
          if (r.length === 0) {
            document.querySelector('.resultInfo').innerHTML =
              `
            Everything is up-to-date! The next avialable update will be on <br><br>
            ${moment().day(5).format("dddd MM/DD/YYYY")}, 12:00PM PST <br><br>
            For the Date Range: <br><br>
            ${moment().day(8).format("MM/DD/YYYY")} - ${moment().day(14).format("MM/DD/YYYY")}
             `
          } else {

            let expressCount = 0
            let groundCount = 0
            let exportCount = 0
            let importCount = 0
            r.forEach(elem => {
              switch (elem.indicator) {
                case 'EXPRESS':
                  expressCount++
                  break;
                case 'GROUND':
                  groundCount++
                  break;
                case 'INTL EXPORT':
                  exportCount++
                  break;
                case 'INTL IMPORT':
                  importCount++
                  break;
              }
            })

            document.querySelector('.resultInfo').innerHTML =
              `
            There were a total of ${r.length} records updated! Please is the update information below: <br><br>
            Date Range: ${moment(r[r.length-1].effective_date).format("MM/DD/YYYY")} - ${moment(r[0].effective_date).format("MM/DD/YYYY")}<br><br>
            Express: ${expressCount} <br><br>
            Ground: ${groundCount} <br><br>
            Intl Export: ${exportCount} <br><br>
            Intl Import: ${importCount} <br><br>
            `
          }
        })
        .catch(e => console.log(e))
    }

    // Cleans the Result Information 
    function closeSync() {
      document.querySelector('.resultInfo').innerHTML = ''
    }


    // Custom Date Filter
    function customDate() {
      let customStartDate = moment(document.querySelector('#customStartDate').value).format("YYYYMMDD")
      let customEndDate = moment(document.querySelector('#customEndDate').value).format("YYYYMMDD")
      if (customStartDate > customEndDate || customEndDate === "Invalid date" || customStartDate === "Invalid date") {
        document.querySelector('#invalidDate').innerHTML = `Invalid Date. Please select a correct date range.`
      } else {
        fuelhistoryData(customStartDate,customEndDate)
        document.querySelector('#invalidDate').innerHTML =''
      }
    }

    // Graph Funcation
    function Graph(dateArr,expressArr,groundArr,exportArr,importArr) {
      Chart.defaults.global.defaultFontColor = 'black'
      new Chart(document.getElementById("myChart"), {
        type: 'line',
        legendText: "cross",
        data: {
          labels: dateArr,
          datasets: [{
            data: expressArr,
            label: "Express",
            borderColor: "#86B281",
            backgroundColor: "#86b281",
            fill: false
          }, {
            data: groundArr,
            label: "Ground",
            borderColor: "#bc8d88",
            backgroundColor: "#bc8d88",
            fill: false
          }, {
            data: exportArr,
            label: "Intl Export",
            borderColor: "#9DB3D5",
            backgroundColor: "#9DB3D5",
            fill: false
          }, {
            data: importArr,
            label: "Intl Import",
            borderColor: "#637885",
            backgroundColor: "#637885",
            fill: false
          }]
        },
        options: {
          legend: {
            position: 'bottom',
            markerColor: "circle"
          },
          scales: {
            yAxes: [{
              ticks: {
                callback: function (tick) {
                  return tick.toString() + '%';
                }
              }
            }]
          }
        }
      })
    }

    Graph()

    // Materialize Code to make Modals Work
    $(document).ready(function () {
      $('.modal').modal()
    })
  </script>

</body>

</html>